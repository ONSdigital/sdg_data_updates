---
title: "8-6-1 checks"
author: "Abhishek Singh"
date: "--/--/----"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
```

```{r include= FALSE}

old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/8-6-1.csv")


# old_data$Series = str_replace(old_data$Series, "Proportion of youth not in education, employment or training", "Yearly")

old_data$Series = gsub( "Proportion of youth not in education, employment or training (quarterly)",
                        "Quaterly", old_data$Series, fixed=TRUE)

old_data$Series = gsub("Proportion of youth not in education, employment or training",
                       "Yearly", old_data$Series, fixed=TRUE)

old_data$Age = gsub(".", "People", old_data$Age, fixed=TRUE)
old_data["Sex"][is.na(old_data["Sex"])] <- "People"


old_data$`Seasonally.adjusted.or.not` = str_replace(old_data$`Seasonally.adjusted.or.not`, "Seasonally adjusted", "SA")
old_data$`Seasonally.adjusted.or.not` = str_replace(old_data$`Seasonally.adjusted.or.not`, "Not seasonally adjusted", "NSA")






date <- Sys.Date()
new_data <- read.csv(paste0(output_folder, "/", date, "_update_8-6-1", ".csv"))

# new_data$Series = str_replace(new_data$Series, "Proportion of youth not in education, employment or training (quarterly)", "Quarterly")
# new_data$Series = str_replace(new_data$Series, "Proportion of youth not in education, employment or training", "Yearly")

new_data$Series = gsub("Proportion of youth not in education, employment or training (quarterly)",
                       "Quaterly", new_data$Series, fixed=TRUE)

new_data$Series = gsub("Proportion of youth not in education, employment or training",
                       "Yearly", new_data$Series, fixed=TRUE)
# new_data$Age = gsub(".", "People", new_data$Age, fixed=TRUE)
new_data["Sex"][is.na(new_data["Sex"])] <- "People"

new_data$`Seasonally.adjusted.or.not` = str_replace(new_data$`Seasonally.adjusted.or.not`, "Seasonally adjusted", "SA")

new_data$`Seasonally.adjusted.or.not` = str_replace(new_data$`Seasonally.adjusted.or.not`, "Not seasonally adjusted", "NSA")



latest_year <- max(new_data$Year)

```

## 14-2-1 update summary

Data for `r min(new_data$Year)` to `r latest_year` have been created and 
saved as `r paste0(date, "_8-6-1", ".csv")` in the 8-6-1 Output folder.  
    
### Check configurations
Please check that the information below is as you expect. In particular, pay 
attention to the time since data were saved, to check that previously 
downloaded data have not accidentally been used.
    
These settings can all be adjusted in `config.R`
    
Files used to create the new data were downloaded and saved in 
8-6-1/`r input_folder`.  
  
```{r include= FALSE}
filename_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", filename), 
                                full.names = TRUE)$ctime[1]
time_since_data_saved <- round(difftime(Sys.time(), filename_save_time, units = "days"), 2)

```

**Total extent and proportion of protected areas at sea (ONS)**  

Protected areas data are in the file `r filename`.   

This file was saved at `r filename_save_time`: It has been 
`r time_since_data_saved` days since the file was saved in 
`r input_folder`  

The tab used is called
`r tabname`. 






### Check data




The charts below show the new data (just created) plotted on top of the old data,
which has been downloaded from the live site. If there are unexpected 
discrepancies in the lines please investigate the reasons for these discrepancies.
    
```{r, echo=FALSE, fig.width=70, fig.height=15}
new_data <- new_data %>%
mutate(Year = as.character(Year),
         dataset = "new")

# For review, how to plot Q1 til Q4 ??



new_data$Value <- as.numeric(new_data$Value)

joined_data <- old_data %>%
  mutate(dataset = "old") %>%
  bind_rows(new_data)

Yearly_plot_data  <- joined_data %>% 
  filter(Series == "Yearly") 

# Yearly plot
Yearly_plot <- joined_data %>%
  filter(Series == "Yearly") %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  # scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(~Series ~Seasonally.adjusted.or.not ~ Age ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Proportion of youth not in education, employment or training by Year")
  

# Quaterly Plot
 
plot <- joined_data %>%
  filter(Series == "Quaterly") %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  # scale_y_continuous(limits=c(min(joined_data$Value), max(joined_data$Value))) +
  geom_point(aes(shape = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(~Series ~Seasonally.adjusted.or.not ~ Age ~ Sex,scales = "free_x", space='free_x') +
  scale_x_discrete(expand = c(0, 0.5)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 3.5)) +
  theme(axis.text.y = element_text(size = 7))
  ggtitle("Proportion of youth not in education, employment or training Quaterly")

```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(plot))
suppressMessages(print(Yearly_plot))
```

###Table of discrepancies

If there are differences, visible in the table below and plots, please investigate these. It is possible the data source has update its back time series, so the difference could be genuine.
```{r, , echo = FALSE}
comparison <- joined_data %>% 
  select(Year, Series, Value, dataset) %>% 
  pivot_wider(names_from = dataset,
              values_from = Value) %>% 
  mutate(difference = new - old) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))
```
	  
	The table below shows all instances where the old value does not match the new value. It is sorted so the largest absolute differences appear first, but can be sorted in other ways using the arrows at the top.
```{r, echo = FALSE}
	datatable(comparison, 
	          rownames = FALSE, 
	          filter = "top",
	          options = list(dom = 'tp', 
	                         pageLength = 10,
	
	
	                         columnDefs = list(list(
	                           className = 'dt-center', targets = 0:3))))
```

















### Calculations

Calculations were made to generate the “Proportion of marine protected area” series. Proportion of marine protected area is calculated using the following formula. 100 * (Extent at sea - million hectares / UK sea area). See C1. Protected Areas for more information on methodology.

The calculations used to create these data were:
```

protected_area_main_data['Proportion_of_area_protected']  <-round((protected_area_main_data['At_Sea']/protected_area_main_data['UK_marine_area'])*100,2)

```
Warning: This is copied from `update_8-6-1.R` and will not dynamically update 
if that code is changed.
