---
title: "3-c-1 QA"
author: "Emma Wood"
date: "16/12/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(DT)
library(pander)
```
**Run date and time: `r Sys.time()`**  
   
## Introduction

3-c-1 is a relatively straightforward indicator but it is an easy automation as
the data are from Nomis, and there is a calculation that is easier to do 
without error in R.

This file runs some basic checks and gives information about the update.

## Configurations
The config file contains only two values:  
  
- nomis_employment_link: data from the 'annual population survey - regional - 
employment by occupation' table on Nomis.  
- nomis_population_link: data from the 'population estimates - local authority 
based by 5 year age band' table on Nomis.  
  
The details of how these links are generated is given in the README file in the 
3-c-1 folder.  Links do not need to be updated unless the selections (e.g. of
occupations) change.
  
## Basic checks
We should only use data for the calendar year (Jan-Dec). The months contained in 
the data for this run are: `r unique_months_retained`.  If the given months are 
incorrect please check the nomis selections are correct, and regenerate the link 
(see the 3-c-1 README file).

```{r, include=FALSE}
if (not_all_data_available == TRUE) {
  print(paste("NOTE: Data for", dataset_behind, "data are only available up to", 
              max_years$max_year[max_years$dataset == dataset_behind], 
              ", though data for", max_years$dataset[max_years$dataset != dataset_behind],
              "are available up to", max_years$max_year[max_years$dataset != dataset_behind]))
}
```


## Plots
Please check the plots below for any differences between the live and new data.
Live data will appear over the top of new data, so if you don't see points for
the new data on dates where there is also live data this is a good thing.  

```{r, echo = FALSE, fig.width=10}
live_data <- read.csv('https://raw.githubusercontent.com/ONSdigital/sdg-data/master/data/indicator_3-c-1.csv')

if("Sex" %in% names(live_data)){
  live_data <- live_data %>% 
    filter(Sex %in% c("All persons", ""))
}


new_data <- csv_formatted %>% 
  mutate(Year = as.integer(Year),
         dataset = "new") %>% 
  rename("Occupation.minor.group" = "Occupation minor group",
         "Occupation.unit.group" = "Occupation unit group") 

  
# join to the new data
joined_data <- live_data %>% 
  mutate(dataset = "live") %>% 
  bind_rows(new_data) %>% 
  mutate(Region = ifelse(is.na(Region), "", Region),
         Country = ifelse(is.na(Country), "", Country))

# plot the data
country_minor_plot <- joined_data %>% 
  filter(Region == "" & Occupation.unit.group == "" ) %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Occupation.minor.group ~ Country) +
  theme_bw() +
  ggtitle("Country by Occupation minor group")


# country by unit group
country_unit_plot <- joined_data %>% 
  filter(Region == "" & Occupation.unit.group != "" ) %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Occupation.unit.group ~ Country) +
  theme_bw() +
  ggtitle("Country by Occupation unit group")

# region by minor group
region_minor_plot <- joined_data %>% 
  filter(Country == "England" & Occupation.unit.group == "" ) %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Region ~ Occupation.minor.group) +
  theme_bw() +
  ggtitle("Region by Occupation minor group")


region_unit_plot <- joined_data %>% 
  filter(Country == "England" & Occupation.unit.group != "" ) %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Region ~ Occupation.unit.group) +
  theme_bw()  +
  ggtitle("Region by Occupation unit group")


```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(country_minor_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height=15}
suppressMessages(print(country_unit_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height=15}
suppressMessages(print(region_minor_plot))
```

```{r, echo = FALSE, fig.width=15, fig.height = 15}
suppressMessages(print(region_unit_plot))
```

## Session Info
```{r}
pander(sessionInfo())
```

