---
title: "3-4-1 QA"
author: "Michael Nairn"
date: "21/11/2022"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(DT)

```
**Run date and time: `r Sys.time()`**  
   
## Introduction

3-4-1 is an inidcator that uses a NOMIS API link to provide data. Unless the 
format of NOMIS API downloads changes, the update_3-4-1 script should not need 
changing. However, always check before running the update script. 

This file runs some basic checks and gives information about the update.
  
Before putting the csv in the indicator file please check if the most recent 
figures are provisional. Check this in the source data. If they 
are, in the indicator csv file change the observation status to 'Provisional'.

## Configurations
The configurations for this run are:    
  
- filepath for input data: **`r paste0(getwd(), "/", input_folder, "/", filename)`**  
- name of the tab the data are in: **`r tab_name`**  
- row number of the column names: **`r header_row`**  
- location of outputs: **`r paste0(getwd(), "/", output_folder)`**  
  
  
## Basic checks

We should only use data for the calendar year (Jan-Dec). The months contained in 
the data for this run are: `r unique_months_retained`.  If the given months are 
incorrect please check the nomis selections are correct, and regenerate the link 
(see the README file).  

The dates listed in the information above `r tab_name`, should match the dates 
produced in the output csv. It is 
`r earliest_year == min(as.numeric(csv_formatted$Year))` 
that the earliest date in the dataset matches the earliest date given above the
table. It is `r latest_year == max(as.numeric(csv_formatted$Year))` 
that the latest date in the dataset matches the latest date given above the
table. If either of these are 'FALSE' please manually check that the numbers in 
the output csv match those in `r paste0(input_folder, "/", filename)`.  
  

## Plots
Please check the plots below for any differences between the live and new data.
Live data will appear over the top of new data, so if you don't see points for
the new data on dates where there is also live data this is a good thing.  

```{r, echo = FALSE}
live_data <- read.csv('https://raw.githubusercontent.com/ONSdigital/sdg-data/master/data/indicator_3-4-1.csv')

new_data <- csv_formatted %>% 
  mutate(Year = as.integer(Year),
         dataset = "new") 
  
# join to the new data
joined_data <- live_data %>% 
  mutate(dataset = "live") %>% 
  bind_rows(new_data)

# plot the data
plot <- joined_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(vars(Gas),
             nrow = 2) +
  theme_bw() 

```

```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(plot))
```


  
**If there are differences (see table below) please check that this still stands**

```{r, , echo = FALSE}
comparison <- joined_data %>% 
  select(Year, Gas, Value, dataset) %>% 
  pivot_wider(names_from = dataset,
              values_from = Value) %>% 
  mutate(difference = new - live) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```
  
The table below shows all instances where the old value does not match the new 
value. It is sorted so the largest absolute differences appear first, but can
be sorted in other ways using the arrows at the top.
```{r, echo = FALSE}
datatable(comparison, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

