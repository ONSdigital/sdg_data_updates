---
title: "8-8-1 checks"
author: "Katie Uzzell"
date: "05/09/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(pander)
library(DT)
```

```{r include= FALSE}

old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/8-8-1.csv")

old_data <- old_data %>% 
  rename("Industry sector" = "Industry.sector", "Units" = "Unit.measure", "Observation status" = "Observation.status", "Unit multiplier" = "Unit.multiplier")

old_data$`Year`[old_data$`Year` == "2019/20 [Note 5]"] <- "2019/20"
old_data$`Year`[old_data$`Year` == "2020/21 [Note 5]"] <- "2020/21"
old_data$`Year`[old_data$`Year` == "2021/22 [Note 5]"] <- "2021/22"

date <- Sys.Date()

new_data <- read.csv(paste0(output_folder, "/", date, "_update_8-8-1", ".csv"))

latest_year <- max(new_data$Year)

new_data <- new_data %>% 
  rename("Industry sector" = "Industry.sector", "Observation status" = "Observation.status", "Unit multiplier" = "Unit.multiplier") 

new_data <- new_data %>% 
  mutate(dataset = "new") %>% 
  mutate(Value = as.numeric(Value))

# join to the new data
joined_data <- old_data %>% 
  mutate(dataset = "old") %>% 
  bind_rows(new_data) %>% 
  mutate(across(everything(), ~ replace(., is.na(.), ""))) %>% 
  mutate(Value = as.numeric(Value))

joined_data[joined_data == ' '] <- ''
```

## **8-8-1 update summary**

Data for `r min(new_data$Year)` to `r latest_year` have been created and saved as `r paste0(date, "_8-8-1", ".csv")` in the 8-8-1 Output folder.  
    
### **Check configurations**
Please check that the information below is as you expect. In particular, pay attention to the time since data were saved, to check that previously downloaded data have not accidentally been used.
    
These settings can all be adjusted in `config.R`
    
Files used to create the new data were downloaded and saved in 
8-8-1/`r input_folder`.  

```{r include= FALSE}

fatal_inj_headline_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", fatal_inj_headline), 
                                full.names = TRUE)$ctime[1]
fatal_inj_headline_time_since_data_saved <- round(difftime(Sys.time(), fatal_inj_headline_save_time, units = "days"), 2)

fatal_inj_region_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", fatal_inj_region), 
                                full.names = TRUE)$ctime[1]
fatal_inj_region_time_since_data_saved <- round(difftime(Sys.time(), fatal_inj_region_save_time, units = "days"), 2)

fatal_inj_age_sex_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", fatal_inj_age_sex), 
                                full.names = TRUE)$ctime[1]
fatal_inj_age_sex_time_since_data_saved <- round(difftime(Sys.time(), fatal_inj_age_sex_save_time, units = "days"), 2)

nonfatal_inj_summary_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", nonfatal_inj_summary), 
                                full.names = TRUE)$ctime[1]
nonfatal_inj_summary_time_since_data_saved <- round(difftime(Sys.time(), nonfatal_inj_summary_save_time, units = "days"), 2)

nonfatal_inj_region_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", nonfatal_inj_region), 
                                full.names = TRUE)$ctime[1]
nonfatal_inj_region_time_since_data_saved <- round(difftime(Sys.time(), nonfatal_inj_region_save_time, units = "days"), 2)

nonfatal_inj_age_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", nonfatal_inj_age), 
                                full.names = TRUE)$ctime[1]
nonfatal_inj_age_time_since_data_saved <- round(difftime(Sys.time(), nonfatal_inj_age_save_time, units = "days"), 2)

nonfatal_inj_ind_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", nonfatal_inj_ind), 
                                full.names = TRUE)$ctime[1]
nonfatal_inj_ind_time_since_data_saved <- round(difftime(Sys.time(), nonfatal_inj_ind_save_time, units = "days"), 2)

nonfatal_inj_occ_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", nonfatal_inj_occ), 
                                full.names = TRUE)$ctime[1]
nonfatal_inj_occ_time_since_data_saved <- round(difftime(Sys.time(), nonfatal_inj_occ_save_time, units = "days"), 2)

```


**Fatal and non-fatal workplace injuries data from Health and Safety Executive (HSE)**

Fatal workplace injury headline data are saved in the `r fatal_inj_headline`. This file was saved at `r fatal_inj_headline_save_time`: It has been 
`r fatal_inj_headline_time_since_data_saved` days since the file was saved in `r input_folder`. 
 
Fatal workplace injury by region data are saved in the `r fatal_inj_region`.This file was saved at `r fatal_inj_region_save_time`: It has been 
`r fatal_inj_region_time_since_data_saved` days since the file was saved in `r input_folder`. 

Fatal workplace injury by age and sex data are saved in the `r fatal_inj_age_sex`. This file was saved at `r fatal_inj_age_sex_save_time`: It has been 
`r fatal_inj_age_sex_time_since_data_saved` days since the file was saved in `r input_folder`. 

Non-fatal workplace injury headline data data are saved in the `r nonfatal_inj_summary`. This file was saved at `r nonfatal_inj_summary_save_time`: It has been 
`r nonfatal_inj_summary_time_since_data_saved` days since the file was saved in `r input_folder`. 

Non-fatal workplace injury by region data are saved in the `r nonfatal_inj_region`. This file was saved at `r nonfatal_inj_region_save_time`: It has been 
`r nonfatal_inj_region_time_since_data_saved` days since the file was saved in `r input_folder`. 

Non-fatal workplace injury by age and sex data are saved in the `r nonfatal_inj_age`. This file was saved at `r nonfatal_inj_age_save_time`: It has been 
`r nonfatal_inj_age_time_since_data_saved` days since the file was saved in `r input_folder`. 

Non-fatal workplace injury by industry data are saved in the `r nonfatal_inj_ind`. This file was saved at `r nonfatal_inj_ind_save_time`: It has been 
`r nonfatal_inj_ind_time_since_data_saved` days since the file was saved in `r input_folder`. 

Non-fatal workplace injury by occupation data are saved in the `r nonfatal_inj_occ`. This file was saved at `r nonfatal_inj_occ_save_time`: It has been 
`r nonfatal_inj_occ_time_since_data_saved` days since the file was saved in `r input_folder`. 


**The tab used for all fatal injury inputs is called `r fatal_tabname`.**

**The tab used for all non-fatal injury inputs is called `r nonfatal_tabname`.**

## **Check data**

Please check the graphs below for any differences between the live and new data. If there are differences visible in the graphs below, please investigate these.

### **Fatal injuries data**

```{r include=FALSE}

# headline

fatal_headline_plot_data <- joined_data[joined_data$Series == "Fatal injury",] 

fatal_headline_plot_data <- fatal_headline_plot_data %>% 
  filter(Age == "" & Sex == "" & Country == "" & Region == "" & `Industry sector` == "" & Occupation == "")

fatal_headline_plot <- fatal_headline_plot_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Fatal headline data")

# sex

fatal_sex_plot_data <- joined_data[joined_data$Series == "Fatal injury",] 

fatal_sex_plot_data <- fatal_sex_plot_data %>% 
  filter(Sex != "")

fatal_sex_plot_data <- fatal_sex_plot_data %>% 
  filter(Age == "")

fatal_sex_plot <- fatal_sex_plot_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Sex, ncol=2) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Fatal sex data")


# age

fatal_age_plot_data <- joined_data[joined_data$Series == "Fatal injury",] 

fatal_age_plot_data <- fatal_age_plot_data %>% 
  filter(Age != "")

fatal_age_plot_data <- fatal_age_plot_data %>% 
  filter(Sex == "")

fatal_age_plot <- fatal_age_plot_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Age, ncol=3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Fatal age data")

#age/sex

fatal_age_sex_plot_data <- joined_data[joined_data$Series == "Fatal injury",] 

fatal_age_sex_plot_data <- fatal_age_sex_plot_data %>% 
  filter(Age != "" & Sex != "")


fatal_age_sex_plot <- fatal_age_sex_plot_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Sex~Age) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Fatal age/sex data")


# country

fatal_country_plot_data <- joined_data[joined_data$Series == "Fatal injury",] 

fatal_country_plot_data <- fatal_country_plot_data %>% 
  filter(Country != "" & Region == "")

fatal_country_plot <- fatal_country_plot_data %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Country, ncol=5) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Fatal country data")

# region

fatal_region_plot_data <- joined_data[joined_data$Series == "Fatal injury",] 

fatal_region_plot_data <- fatal_region_plot_data %>% 
  filter(Country == "England" & Region != "")

fatal_region_plot <- fatal_region_plot_data %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Region, ncol=5) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Fatal region data")

# industry (NEED TO SORT!)

fatal_industry_plot_data <- joined_data[joined_data$Series == "Fatal injury",] 

fatal_industry_plot_data <- fatal_industry_plot_data %>% 
  filter(`Industry sector` != "")

fatal_industry_plot <- fatal_industry_plot_data %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~`Industry sector`, ncol=3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Fatal industry data")



```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}

suppressMessages(print(fatal_headline_plot))
suppressMessages(print(fatal_sex_plot))
suppressMessages(print(fatal_age_plot))
suppressMessages(print(fatal_age_sex_plot))
suppressMessages(print(fatal_country_plot))
suppressMessages(print(fatal_region_plot))
suppressMessages(print(fatal_industry_plot))
```

### **Non-fatal injuries data**

```{r include=FALSE}

# headline (NEEDS)

nonfatal_headline_plot_data <- joined_data[joined_data$Series == "Non-fatal injury",] 

nonfatal_headline_plot_data <- nonfatal_headline_plot_data %>% 
  filter(Age == "" & Sex == "" & Country == "" & Region == "" & `Industry sector` == "" & Occupation == "")

nonfatal_headline_plot <- nonfatal_headline_plot_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Non-fatal headline data")

# sex

nonfatal_sex_plot_data <- joined_data[joined_data$Series == "Non-fatal injury",] 

nonfatal_sex_plot_data <- nonfatal_sex_plot_data %>% 
  filter(Sex != "")

nonfatal_sex_plot_data <- nonfatal_sex_plot_data %>% 
  filter(Age == "")

nonfatal_sex_plot <- nonfatal_sex_plot_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Sex, ncol=2) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Non-fatal sex data")


# age

nonfatal_age_plot_data <- joined_data[joined_data$Series == "Non-fatal injury",] 

nonfatal_age_plot_data <- nonfatal_age_plot_data %>% 
  filter(Age != "")

nonfatal_age_plot_data <- nonfatal_age_plot_data %>% 
  filter(Sex == "")

nonfatal_age_plot <- nonfatal_age_plot_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Age, ncol=3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Non-fatal age data")

#age/sex

nonfatal_age_sex_plot_data <- joined_data[joined_data$Series == "Non-fatal injury",] 

nonfatal_age_sex_plot_data <- nonfatal_age_sex_plot_data %>% 
  filter(Age != "" & Sex != "")


nonfatal_age_sex_plot <- nonfatal_age_sex_plot_data %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Sex~Age) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Non-fatal age/sex data")


# country

nonfatal_country_plot_data <- joined_data[joined_data$Series == "Non-fatal injury",] 

nonfatal_country_plot_data <- nonfatal_country_plot_data %>% 
  filter(Country != "" & Region == "")

nonfatal_country_plot <- nonfatal_country_plot_data %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Country, ncol=5) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Non-fatal country data")

# region

nonfatal_region_plot_data <- joined_data[joined_data$Series == "Non-fatal injury",] 

nonfatal_region_plot_data <- nonfatal_region_plot_data %>% 
  filter(Country == "England" & Region != "")

nonfatal_region_plot <- nonfatal_region_plot_data %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Region, ncol=5) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Non-fatal region data")

# industry (NEED TO SORT!)

nonfatal_industry_plot_data <- joined_data[joined_data$Series == "Non-fatal injury",] 

nonfatal_industry_plot_data <- nonfatal_industry_plot_data %>% 
  filter(`Industry sector` != "")

nonfatal_industry_plot <- nonfatal_industry_plot_data %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~`Industry sector`, ncol=3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Non-fatal industry data")

# occupation

nonfatal_occupation_plot_data <- joined_data[joined_data$Series == "Non-fatal injury",] 

nonfatal_occupation_plot_data <- nonfatal_occupation_plot_data %>% 
  filter(Occupation != "")

nonfatal_occupation_plot <- nonfatal_occupation_plot_data %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(~Occupation, ncol=3) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Non-fatal occupation data")


```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}

suppressMessages(print(nonfatal_headline_plot))
suppressMessages(print(nonfatal_sex_plot))
suppressMessages(print(nonfatal_age_plot))
suppressMessages(print(nonfatal_age_sex_plot))
suppressMessages(print(nonfatal_country_plot))
suppressMessages(print(nonfatal_region_plot))
suppressMessages(print(nonfatal_industry_plot))
suppressMessages(print(nonfatal_occupation_plot))
```

## **Calculations**

No calculations were performed on this data during the automated update. 

## **Session Info**
```{r}
pander(sessionInfo())
```

