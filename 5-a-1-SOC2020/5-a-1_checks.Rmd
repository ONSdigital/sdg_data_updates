---
title: "5-a-1_checks"
author: "Michael Nairn"
date: "04/01/2023"
output: html_document


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(DT)
library(pander)
```



   
## 5-a-1 update summary

Indicator 5-a-1 is an indicator that uses a NOMIS API link to provide data. Unless the 
format of NOMIS API downloads changes, the update_5-a-1 script should not need 
changing. However, always check before running the update script. 

This file runs some basic checks and gives information about the update.
  
Before putting the csv in the indicator file please check if the most recent 
figures are provisional. Check this in the source data. If they 
are, in the indicator csv file change the observation status to 'Provisional'.


```{r include= FALSE}
old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/5-a-1.csv") %>% 
  mutate(Sex = "Female") %>% 
  mutate(Country = "") %>%
  mutate(Region = "") %>%
  select(Year, `Occupation.unit.group`, Country, Region, Sex, `Observation.status`, `Unit.measure`, Value) %>%
  mutate(dataset = "old") 
  

old_data$`Occupation.unit.group` <- sub("^$", "Managers and proprietors in agriculture related services", old_data$`Occupation.unit.group`)
old_data$`Occupation.unit.group` <- sub("Managers and proprietors in forestry fishing and related services", "Managers and proprietors in forestry, fishing and related services", old_data$`Occupation.unit.group`)


date <- Sys.Date()


new_data <- read.csv(paste0(output_folder, "/", date, "_5-a-1", ".csv")) %>%
  mutate(Year = as.integer(Year),
         dataset = "new")

```         


```{r include= FALSE}
latest_year <- max(new_data$Year)

# join to the new data
joined_data <- old_data %>% 
  bind_rows(new_data) %>%
  rename(`Observation status` = `Observation.status`,
         `Occupation unit group` = `Occupation.unit.group`,
         `Unit measure` = `Unit.measure`)

```


## Plots
Please check the plots below for any differences between the live and new data.
Live data will appear over the top of new data, so if you don't see points for
the new data on dates where there is also live data this is a good thing. 

Please note that prior to January 2023 update we used an alternative data source,
and therefore, for this update, the old and new data will not be identical.
However, the magnitude of differences should be quite small.
The new data, from NOMIS, has further disaggregations, by country and region.



```{r, echo = FALSE, fig.width=10}

# Headline plot
headline_plot <- joined_data %>% 
  filter(Country == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Occupation unit group` ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Occupation Group by Sex")


# Country plot - all agricultural services
country_plot_services <- joined_data %>% 
  filter(Region == "" & `Occupation unit group` == "Managers and proprietors in agriculture related services") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(Country ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Managers and proprietors in agriculture related services by country")

# Country plot - agriculture & horticulture
country_plot_agr_and_hort <- joined_data %>% 
  filter(Region == "" & `Occupation unit group` == "Managers and proprietors in agriculture and horticulture") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(Country ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Managers and proprietors in agriculture and horticulture by country")


# Country plot - forestry and fishing
country_plot_for_and_fish <- joined_data %>% 
  filter(Region == "" & `Occupation unit group` == "Managers and proprietors in forestry, fishing and related services") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(Country ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Managers and proprietors in forestry, fishing and related services by country")



# Regional plot - all agricultural services
region_plot_services <- joined_data %>% 
  filter(Region != "" & `Occupation unit group` == "Managers and proprietors in agriculture related services") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(Region ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Managers and proprietors in agriculture related services by region")

# Regional plot - agriculture & horticulture
region_plot_agr_and_hort <- joined_data %>% 
  filter(Region != "" & `Occupation unit group` == "Managers and proprietors in agriculture and horticulture") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(Region ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Managers and proprietors in agriculture and horticulture by region")


# Regional plot - forestry and fishing
region_plot_for_and_fish <- joined_data %>% 
  filter(Region != "" & `Occupation unit group` == "Managers and proprietors in forestry, fishing and related services") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(Region ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Managers and proprietors in forestry, fishing and related services by region")


```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(headline_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(country_plot_services))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(country_plot_agr_and_hort))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(country_plot_for_and_fish))
```

 
```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(region_plot_services))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(region_plot_agr_and_hort))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(region_plot_for_and_fish))
``` 
  
    
**If there are differences (see table below) please check that this still stands**


Please note that prior to January 2023 update we used an alternative data source,
and therefore, for this update, the old and new data will not be identical.
The new data, from NOMIS, has further disaggregations, by country and region,
hence why it is being used.

However, for all future updates (post January 2023) 
all differences need to be addressed.

```{r, , echo = FALSE}
comparison <- joined_data %>% 
  select(Year, `Occupation unit group`, Country, Region, Sex, Value, dataset) %>% 
  pivot_wider(names_from = dataset,
              values_from = Value) %>% 
  mutate(difference = new - old) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))
```

  
The table below shows all instances where the old value does not match the new 
value. It is sorted so the largest absolute differences appear first, but can
be sorted in other ways using the arrows at the top.

```{r, echo = FALSE}
datatable(comparison, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

## Session Info
```{r}
pander(sessionInfo())
```