title: "4-1-1 Checks"
author: "Michael Nairn"
date: "23/05/2023"
output: html_document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(DT)
library(pander)
```



   
## 4-1-1 update summary

This file runs some basic checks and gives information about the update.

Attainment at age 11 data prior to 2018 to 2019 is not generated by this automation. Therefore, ensure this data in the csv sheet of the indicator file is not overwritten when adding the automation generated csv output. 
  
Before putting the csv in the indicator file please check if the most recent 
figures are provisional. Check this in the source data. If they 
are, in the indicator csv file change the observation status to 'Provisional'.



```{r include= FALSE}
old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/4-1-1.csv") %>% 
  rename(`Local Authority` = `Local.Authority`) %>%
  rename(`Special educational needs (SEN) status` = `Special.educational.needs`) %>%
  rename(`Free school meal status` = Free.school.meals) %>%
  filter(`Ethnic.group` == "") %>%
  rename(`old Ethnic group` = Ethnic.group) %>%
  rename(`Ethnic group` = Ethnicity) %>% 
  mutate(`Disadvantaged status` = "") %>% 
  mutate(`First language` = "") %>%
  mutate(dataset = "old") %>%
  select(Year, Series, Subject, Region, `Local Authority`, Sex,
         `Ethnic group`, `Special educational needs (SEN) status`,
         `Disadvantaged status`, `Free school meal status`, `First language`,
          Value, dataset)

# reformat the years by subbing in " to 20" after the fourth value in the string
old_data$Year <- gsub("^(.{4})(.*)$",         
                           "\\1 to 20\\2",
                           old_data$Year) 

# remove the / from the year
old_data$Year <- gsub("/", "",old_data$Year)
  

date <- Sys.Date()
new_data <- read.csv(paste0("Output/", date, "_4-1-1", ".csv")) %>% 
  mutate(dataset = "new") %>%
  rename(`Local Authority` = `Local.Authority`) %>%
  rename(`Special educational needs (SEN) status` = Special.educational.needs..SEN..status) %>%
  rename(`Free school meal status` = Free.school.meal.status) %>%
  rename(`Ethnic group` = Ethnic.group) %>% 
  rename(`Disadvantaged status` = Disadvantaged.status) %>%
  rename(`First language` = First.language) %>%
  select(Year, Series, Subject, Region, `Local Authority`, Sex,
         `Ethnic group`, `Special educational needs (SEN) status`,
         `Disadvantaged status`, `Free school meal status`, `First language`,
          Value, dataset)
 

# join to the new data
joined_data <- old_data %>% 
  bind_rows(new_data) 



```





```{r, , echo = FALSE}
comparison <- joined_data %>% 
  na.omit(Value) %>% # replace the NULL returns with NA
  pivot_wider(names_from = dataset,
              values_from = Value)


comparison <- comparison %>% 
  mutate(across("old":"new", ~replace(., lengths(.) == 0, ""))) %>%
  mutate(new = as.character(new)) %>%
  mutate(new = as.numeric(new)) %>%
  mutate(old = as.character(old)) %>%
  mutate(old = as.numeric(old))

comparison <- comparison %>% 
  mutate(difference = new - old) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```

## Table of discrepancies
The table below shows all instances where the old value does not match the new 
value. It is sorted so the largest absolute differences appear first, but can
be sorted in other ways using the arrows at the top.

If there are differences, visible in the table and plots below, please investigate these.
It is possible the data source has update its back time series, so the difference
could be genuine. 



```{r, echo = FALSE}
datatable(comparison, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```
  



## Headline Plots
Please check the plots below for any differences between the live and new data.
Live data will appear over the top of new data, so if you don't see points for
the new data on dates where there is also live data this is a good thing. 

For the May 2023 update there are a number of new disaggregations not previously 
available on the live site. Therefore, there will be a lot of incomparable 
data points on the charts. 



```{r, echo = FALSE, fig.width=10}

# Attainment at age 7 by subject
Age_7_headline_plot <- joined_data %>% 
  filter(Series == "Attainment at age 7" & Region == "" & `Local Authority` == "" 
         & `Ethnic group` == "" & Sex == "" & `Disadvantaged status` == "" &
        `Special educational needs (SEN) status` == "" & `First language` == "" &
          `Free school meal status` == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Series ~ Subject) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Attainment at age 7 by subject")


# Attainment at age 11 by subject
Age_11_headline_plot <- joined_data %>% 
  filter(Series == "Attainment at age 11" & Region == "" & `Local Authority` == "" 
         & `Ethnic group` == "" & Sex == "" & `Disadvantaged status` == "" &
        `Special educational needs (SEN) status` == "" & `First language` == "" &
          `Free school meal status` == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Series ~ Subject) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Attainment at age 11 by subject")


# Attainment at age 16 by subject
Age_16_headline_plot <- joined_data %>% 
  filter(Series == "Attainment at age 16" & Region == "" & `Local Authority` == "" 
         & `Ethnic group` == "" & Sex == "" & `Disadvantaged status` == "" &
        `Special educational needs (SEN) status` == "" & `First language` == "" &
          `Free school meal status` == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Series ~ Subject) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Attainment at age 16 by subject")


```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(Age_7_headline_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(Age_11_headline_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(Age_16_headline_plot))
```


## Disaggregation Plots

There are too many possible time series to plot here 
but below are a few examples you can amend if there seems to be a discrepancy. In 
particular for any discrepancies shown in the table. 
You may need to change the filters in the plots.

For example, changing the Subject == "Maths" filter. 

For example, removing the `Free school meal status` == "" filter to investigate 
free school meals data. Note, you will have to include the Sex == "" filter, 
as with the headline plots above. 

For example, selecting specific local authorities by editing the "filter" command to 
include the local authorities you wish to compare. 
  E.g.   filter(`Local authority` == "Barking and Dagenham" | 
                `Local authority` == "Barnsley")



```{r, echo = FALSE, fig.width=10}

# Maths attainment at age 7 by Sex
Age_7_maths_sex_plot <- joined_data %>% 
  filter(Series == "Attainment at age 7" & Region == "" & `Local Authority` == "" 
         & `Ethnic group` == "" & `Disadvantaged status` == "" &
        `Special educational needs (SEN) status` == "" & `First language` == "" &
          `Free school meal status` == "" & Subject == "Maths") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Series ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Maths attainment at age 7 by sex")


# Maths attainment at age 11 by sex
Age_11_maths_sex_plot <- joined_data %>% 
  filter(Series == "Attainment at age 11" & Region == "" & `Local Authority` == "" 
         & `Ethnic group` == "" & `Disadvantaged status` == "" &
        `Special educational needs (SEN) status` == "" & `First language` == "" &
          `Free school meal status` == ""  & Subject == "Maths") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Series ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Maths attainment at age 11 by sex")


# Maths attainment at age 16 by sex
Age_16_maths_sex_plot <- joined_data %>% 
  filter(Series == "Attainment at age 16" & Region == "" & `Local Authority` == "" 
         & `Ethnic group` == "" & `Disadvantaged status` == "" &
        `Special educational needs (SEN) status` == "" & `First language` == "" &
          `Free school meal status` == "" & Subject == "Maths") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Series ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Maths attainment at age 16 by sex")


```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(Age_7_maths_sex_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(Age_11_maths_sex_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(Age_16_maths_sex_plot))
```

```{r, echo = FALSE, fig.width=10}

# Maths attainment at age 7 by SEN
Age_7_maths_SEN_plot <- joined_data %>% 
  filter(Series == "Attainment at age 7" & Region == "" & `Local Authority` == "" 
         & `Ethnic group` == "" & `Disadvantaged status` == "" & Sex == "" & 
        `First language` == "" & `Free school meal status` == "" & Subject == "Maths") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Series ~ `Special educational needs (SEN) status`) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Maths attainment at age 7 by SEN")


# Maths attainment at age 11 by SEN
Age_11_maths_SEN_plot <- joined_data %>% 
  filter(Series == "Attainment at age 11" & Region == "" & `Local Authority` == "" 
         & `Ethnic group` == "" & `Disadvantaged status` == "" &
        Sex == "" & `First language` == "" &
          `Free school meal status` == ""  & Subject == "Maths") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_grid(Series ~ `Special educational needs (SEN) status`) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Maths attainment at age 11 by SEN")



```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(Age_7_maths_SEN_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(Age_11_maths_SEN_plot))
```



## Session Info
```{r}
pander(sessionInfo())
```

