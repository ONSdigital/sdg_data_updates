---
title: "8-8-1 checks"
author: "Katie Uzzell"
date: "10/08/2023"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(pander)
library(DT)
```

```{r include= FALSE}

old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/8-8-1.csv")

old_data <- old_data %>% 
  rename("Local Authority" = "Local.Authority", "Observation status" = "Observation.status", "Unit multiplier" = "Unit.multiplier") %>% 
  select("Year", "Series", "Country", "Region", "Local Authority", "Units", "Unit multiplier", "Observation status", "Value")

date <- Sys.Date()

new_data <- read.csv(paste0(output_folder, "/", date, "_update_8-8-1", ".csv"))

new_data <- new_data %>% 
  rename("Local Authority" = "Local.Authority", "Observation status" = "Observation.status", "Unit multiplier" = "Unit.multiplier")

new_data <- new_data %>% 
  mutate(dataset = "new")

# join to the new data
joined_data <- old_data %>% 
  mutate(dataset = "old") %>% 
  bind_rows(new_data) %>% 
  mutate(across(everything(), ~ replace(., is.na(.), ""))) %>% 
  mutate(Value = as.numeric(Value))
```

## 8-8-1 update summary

Data for `r min(new_data$Year)` to `r latest_year` have been created and 
saved as `r paste0(date, "_8-8-1", ".csv")` in the 8-8-1 Output folder.  
    
### Check configurations
Please check that the information below is as you expect. In particular, pay attention to the time since data were saved, to check that previously 
downloaded data have not accidentally been used.
    
These settings can all be adjusted in `config.R`
    
Files used to create the new data were downloaded and saved in 
8-8-1/`r input_folder`.  

```{r include= FALSE}

banks_country_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", banks_country), 
                                full.names = TRUE)$ctime[1]
banks_country_time_since_data_saved <- round(difftime(Sys.time(), banks_country_save_time, units = "days"), 2)

bs_country_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", bs_country), 
                                full.names = TRUE)$ctime[1]
bs_country_time_since_data_saved <- round(difftime(Sys.time(), bs_country_save_time, units = "days"), 2)

banks_region_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", banks_region), 
                                full.names = TRUE)$ctime[1]
banks_region_time_since_data_saved <- round(difftime(Sys.time(), banks_region_save_time, units = "days"), 2)

bs_region_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", bs_region), 
                                full.names = TRUE)$ctime[1]
bs_region_time_since_data_saved <- round(difftime(Sys.time(), bs_region_save_time, units = "days"), 2)

banks_la_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", banks_la), 
                                full.names = TRUE)$ctime[1]
banks_la_time_since_data_saved <- round(difftime(Sys.time(), banks_la_save_time, units = "days"), 2)

bs_la_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", bs_la), 
                                full.names = TRUE)$ctime[1]
bs_la_time_since_data_saved <- round(difftime(Sys.time(), bs_la_save_time, units = "days"), 2)

pop_ests_country_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", pop_ests_country), 
                                full.names = TRUE)$ctime[1]
pop_ests_country_time_since_data_saved <- round(difftime(Sys.time(), pop_ests_country_save_time, units = "days"), 2)

pop_ests_region_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", pop_ests_region), 
                                full.names = TRUE)$ctime[1]
pop_ests_region_time_since_data_saved <- round(difftime(Sys.time(), pop_ests_region_save_time, units = "days"), 2)

pop_ests_la_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", pop_ests_la), 
                                full.names = TRUE)$ctime[1]
pop_ests_la_time_since_data_saved <- round(difftime(Sys.time(), pop_ests_la_save_time, units = "days"), 2)

```


#### **Business counts data from IDBR (ONS) - Nomis**

Number of banks by country data are saved in the `r banks_country`. This file was saved at `r banks_country_save_time`: It has been 
`r banks_country_time_since_data_saved` days since the file was saved in `r input_folder`. 
 
Number of banks by region data are saved in the `r banks_region`.This file was saved at `r banks_region_save_time`: It has been 
`r banks_region_time_since_data_saved` days since the file was saved in `r input_folder`. 

Number of banks by local authority data are saved in the `r banks_la`. This file was saved at `r banks_la_save_time`: It has been 
`r banks_la_time_since_data_saved` days since the file was saved in `r input_folder`. 

Number of building societies by country data are saved in the `r bs_country`. This file was saved at `r bs_country_save_time`: It has been 
`r bs_country_time_since_data_saved` days since the file was saved in `r input_folder`. 

Number of building societies by region data are saved in the `r bs_region`. This file was saved at `r bs_region_save_time`: It has been 
`r bs_region_time_since_data_saved` days since the file was saved in `r input_folder`. 

Number of building societies by local authority data are saved in the `r bs_la`. This file was saved at `r bs_la_save_time`: It has been 
`r bs_la_time_since_data_saved` days since the file was saved in `r input_folder`. 


#### **Population estimates (ONS) - NOMIS**

Population estimates by country data are saved in the `r pop_ests_country`. This file was saved at `r pop_ests_country_save_time`: It has been 
`r pop_ests_country_time_since_data_saved` days since the file was saved in `r input_folder`. 
 
Population estimates by region data are saved in the `r pop_ests_region`.This file was saved at `r pop_ests_region_save_time`: It has been 
`r pop_ests_region_time_since_data_saved` days since the file was saved in `r input_folder`. 

Population estimates by local authority data are saved in the `r pop_ests_la`. This file was saved at `r pop_ests_la_save_time`: It has been 
`r pop_ests_la_time_since_data_saved` days since the file was saved in `r input_folder`.


**The tab used for all inputs is called `r tabname`.**

## **Check data**

Please check the table below for any differences between the live and new data. If there are differences visible in the table below, please investigate these.

```{r include=FALSE}

comparison <- joined_data %>% 
  select(Year, Series, Country, Region, `Local Authority`, Value, dataset) %>%
  pivot_wider(names_from = dataset,
              values_from = Value)

comparison <- comparison %>% 
  mutate(difference = new - old) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```


```{r, echo = FALSE}
datatable(comparison, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

### Calculations

Rate was calculated using the following formula:

((Number of banks + Number of building societies) / Population)) * 100000

## Session Info
```{r}
pander(sessionInfo())
```

