---
title: "QA 3-9-1"
author: "Emma Wood"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(DT)
```
## Introduction

3-9-1 is one of the indicators on Fingertips. The source can be a pain to locate,
and it is very straightforward to update. It used to be automated using Python,
but that code is now in the archive as it used an out of date link.  
  
The method for this PHE Public Health Outcome Framework indicator has recently
been changed but they do not intend to use the new method on the backseries. The 
two series should not be presented on the same chart without making this clear
   
This file runs some basic checks on the csv output and highlights some specific 
things that should manually be checked.
  
- specific things that should be checked in addition to reading this document 
e.g. if provisional figures are likely to be included but this info is not 
picked up by the automation you may put something like "Before putting the csv 
in the indicator file please check in the source data if the most recent 
figures are provisional. If they are, in the indicator csv file change the 
observation status to 'Provisional'."  
  
- other important info you think the user needs to be aware of.
  
## Configurations
in this section list the settings (configurations) and use snippets of code to 
print the user input. The double asterisks make the text bold, while `r` tells 
markdown to read the text inside the back-ticks as code. 

An example of what you may put in this section -
  
  The configurations are:  
  
  - filepath for the input data: **`r paste0(getwd(), "/", input_folder, "/", csv_filename)`**
  - name of the tab the data are in: **`r tab_name`**  
  
  
## Basic checks
Deprivation deciles are based on different IMDs depending on the year. This 
information should be checked in the metadata tab of the indicator file. If it
doesn't match what is shown in the table below, please correct it.

```{r}
print(deprivation_note_compiled)

```
   
age is `r unique(required_compiled$age)`  
sex is `r unique(required_compiled$sex)`  

## Plots
Please check the plots below for any differences between the live data (which 
is pulled in from the live site) and the new data.  
  
Live data will appear over the top of new data. You should therefore only 
see points for the live data for previous years and only points for the new data 
in the years you are updating. 

```{r}
# functions for making tables & plots of differences between live and new data
# plots:
filter_for_plot <- function(series_value, var1, var2) {
  
  standard_cols <- c("year", "value", "units", "series",
                     "observation_status", "unit_multiplier",
                     "dataset", var1, var2)
  
  series_filter <- joined_data %>% 
    filter(series == series_value)
  
  # get just the columns we want to filter to be blank
  disaggs <- setdiff(names(joined_data), standard_cols)
  
  for (i in 1:length(disaggs)) {
    series_filter <- series_filter %>% 
      filter(!!(as.name(disaggs[i])) == "" | is.na(!!(as.name(disaggs[i]))))
  }
  
  return(series_filter)
} 
make_plot <- function(dat, var1, var2) {
  
  ggplot(dat,
         aes(x = year,
             y = value,
             colour = dataset)) +
    geom_point() +
    geom_line() +
    facet_grid(vars({{var1}}), vars({{var2}})) +
    theme_bw() +
    theme(axis.text.x = element_text(angle = 45,
                                     vjust = 1, hjust = 1))
}
# tables
calculate_differences <- function(dat, var1, var2) {
  
  dat %>% 
    mutate(disagg_combo = paste(!!as.name(var1), ",", !!as.name(var2))) %>% 
    select(year, series, disagg_combo,
           dataset, value)  %>% 
    pivot_wider(names_from = dataset,
                values_from = value) %>% 
    mutate(difference = new - live) %>% 
    filter(difference != 0) %>%
    # put the largest differences at the top
    arrange(desc(abs(difference)))
  
}
# and then to present it as a datatable
create_datatable <- function (data) {
  
  datatable(data, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 3,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
}
```

```{r, echo = FALSE, fig.width=10}

# do this properly once new data are live - at the moment the two are too
# different to code easily. Figures that are calculated the same do match.

live_data <- read.csv('https://raw.githubusercontent.com/ONSdigital/sdg-data/master/data/indicator_3-9-1.csv') %>%
  janitor::clean_names() %>% 
  mutate(dataset = "live") %>% 
  mutate(across(where(is.character), str_squish)) 

# local authority is different in the new data

new_data <- read.csv(paste0(output_folder, "/", csv_filename)) %>%
  janitor::clean_names() %>% 
  mutate(dataset = "new") %>% 
  mutate(across(where(is.character), str_squish)) 

# join to the new data
joined_data <- live_data %>% 
  bind_rows(new_data) %>% 
  mutate(region = ifelse(region == "England", "", region))

# plot the data
joined_data %>% 
  filter(#(is.na(region) | region == "") & 
           (is.na(local_authority) | local_authority == "") & 
           (is.na(deprivation_decile) | deprivation_decile == "")) %>%  
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line() +
  facet_wrap(vars(region),
             nrow = 2) +
  theme_bw() 

```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(plot))
```

Finally, it is sometimes hard to see where new numbers don't match live numbers
especially if there are lots of disaggregations. In such cases a table of 
differences is also useful. The following example is taken from 13-2-2:
  
  At the time of writing this code (June 2022), the following note is given in the
  source notes tab: 'in these statistics the entire time series going back to 
  1990 is revised each year to take account of methodological improvements'.  
  
  **If there are differences (see table below) please check that this still stands**

```{r, , echo = FALSE}
comparison <- joined_data %>% 
  select(year, value, dataset) %>% 
  pivot_wider(names_from = dataset,
              values_from = value) %>% 
  mutate(difference = new - live) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```
  
  The table below shows all instances where the old value does not match the new 
  value. It is sorted so the largest absolute differences appear first, but can
  be sorted in other ways using the arrows at the top.
```{r, echo = FALSE}
datatable(comparison, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

## Session Info
```{r}
pander(sessionInfo())
```

pander(sessionInfo())
