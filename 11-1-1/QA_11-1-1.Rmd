---
title: "template QA"
author: "Emma Wood"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(DT)
library(pander)
```
**Run date and time: `r Sys.time()`**  
  
## Introduction

The source data for 11-1-1 are on two spreadsheets and each year is given on a 
separate tab. Updating the indicator and making sure revisions are spotted 
therefore takes quite a long time.  
  
In addition, not all possible disaggregations were included on the platform 
before this automation. This may be partly due to the time consuming nature of
including all variables.  
  
This file runs some basic checks on the csv output and highlights some specific 
things that should manually be checked.  
  
Data in the csv are labelled as 'Normal data' in the Observation status column. 
However, notes should be checked in the spreadsheet to ensure this is correct
for new data.  
   
## Configurations

There are two series for this indicator, which are stored in separate files:  
- filepath for the 'dwellings' data: **`r paste0(getwd(), "/", input_folder, "/", areas_filename)`**  
- filepath for the 'households' data: **`r paste0(getwd(), "/", input_folder, "/", households_filename)`**    
  
There are multiple headers, however all the information we need for column names
is on the header just above the values. The row on which this header is found is
set using the 'header_row' arguments in the config file:  
- row number of the column names for dwellings data: **`r areas_header_row`**  
- row number of the column names for households data: **`r households_header_row`**    
  
There is a tab for each year. Which years to run is set in the configs. For this 
run the following tabs were set to run: **`r tabnames`**  
   
Location of the outputs: **`r paste0(getwd(), "/", output_folder`)**  


## Plots
Please check the plots below for any differences between the live data (which 
is pulled in from Jemalex) and the new data.  
    
Live data will appear over the top of new data. You should therefore only 
see points for the live data for previous years and only points for the new data 
in the years you are updating. 

```{r, echo = FALSE, fig.width=10}

live_data <- read.csv('https://raw.githubusercontent.com/ONSdigital/sdg-data/master/data/indicator_11-1-1.csv') %>% 
  janitor::clean_names()

new_data <- csv_data %>% 
  mutate(across(everything(), ~ replace(., is.na(.), ""))) %>%
  mutate(Year = as.integer(Year),
         Value = as.numeric(Value),
         dataset = "new") %>% 
  janitor::clean_names()

# join to the new data
joined_data <- live_data %>% 
  mutate(dataset = "live") %>% 
  bind_rows(new_data) %>% 
  mutate(across(everything(), ~ replace(., is.na(.), ""))) %>% 
  mutate(year = as.integer(year),
         value = as.numeric(value))
         
```

```{r}
# functions for plotting

filter_for_plot <- function(series_value, var1, var2) {
  
  standard_cols <- c("year", "value", "units", "series",
                     "observation_status", "unit_multiplier",
                     "dataset", var1, var2)
  
  series_selection <- joined_data %>% 
    filter(series == series_value)
  
  # get just the columns we want to filter to be blank
  disaggs <- setdiff(names(joined_data), standard_cols)
  
  for (i in 1:length(disaggs)) {
    series_selection <- series_selection %>% 
      filter(!!(as.name(disaggs[i])) == "" | is.na(!!(as.name(disaggs[i]))))
  }
  
  return(series_selection)
} 

make_plot <- function(dat, var1, var2) {
  
  ggplot(dat,
         aes(x = year,
             y = value,
             colour = dataset)) +
    geom_point() +
    geom_line() +
    facet_grid(vars({{var1}}), vars({{var2}})) +
    theme_bw() 
}
```


### Series: Dwellings 
#### Decent homes criteria by urbanisation sub-category
```{r, echo = FALSE, fig.width=10}

dwell_criteria_ur_plot <- filter_for_plot("Dwellings (%)" , 
                                          "decent_homes_criteria", 
                                          "urbanisation_sub_category") %>% 
  make_plot(.,
            decent_homes_criteria, urbanisation_sub_category)

print(dwell_criteria_ur_plot)

```

#### Decent homes criteria by sub-national area
```{r, echo = FALSE, fig.width=10}

dwell_subnat_plot <- filter_for_plot("Dwellings (%)" , 
                                                "decent_homes_criteria", 
                                                "sub_national_area") %>% 
  make_plot(.,
            decent_homes_criteria, sub_national_area)

print(dwell_subnat_plot)

```

#### Decent homes criteria by region
```{r, echo = FALSE, fig.width=10}

dwell_region_plot <- filter_for_plot("Dwellings (%)" , 
                                                "decent_homes_criteria", 
                                                "region") %>% 
  make_plot(.,
            decent_homes_criteria, region)

suppressMessages(print(dwell_region_plot))

```

#### Decent homes criteria by IMD
```{r, echo = FALSE, fig.width=10}

dwell_imd_plot <- filter_for_plot("Dwellings (%)" , 
                                                "decent_homes_criteria", 
                                                "deprivation_decile") %>% 
  make_plot(.,
            decent_homes_criteria, deprivation_decile)

suppressMessages(print(dwell_imd_plot))

```

### Series: Households
#### Decent homes criteria by age of oldest person
```{r, echo = FALSE, fig.width=10}

hh_old_plot <- filter_for_plot("Households (%)" , 
                               "decent_homes_criteria", 
                               "age_of_oldest_person") %>% 
  make_plot(.,
            decent_homes_criteria, age_of_oldest_person)

print(hh_old_plot)

```
  
#### Decent homes criteria by age of youngest person
```{r, echo = FALSE, fig.width=10}

hh_young_plot <- filter_for_plot("Households (%)" , 
                                 "decent_homes_criteria", 
                                 "age_of_youngest_person") %>% 
  make_plot(.,
            decent_homes_criteria, age_of_youngest_person)

print(hh_young_plot)

```

#### Decent homes criteria by disability status (HH)
```{r, echo = FALSE, fig.width=10}

hh_disability_plot <- filter_for_plot("Households (%)" , 
                                 "decent_homes_criteria", 
                                 "disability_status_household") %>% 
  make_plot(.,
            decent_homes_criteria, disability_status_household)

print(hh_disability_plot)

```

#### Decent homes criteria by ethnicity (HH)
```{r, echo = FALSE, fig.width=10}

hh_ethnicity_plot <- filter_for_plot("Households (%)" , 
                                 "decent_homes_criteria", 
                                 "ethnicity_of_household_reference_person_hrp") %>% 
  make_plot(.,
            decent_homes_criteria, ethnicity_of_household_reference_person_hrp)

print(hh_ethnicity_plot)

```

#### Decent homes criteria by income
```{r, echo = FALSE, fig.width=10}

hh_income_plot <- filter_for_plot("Households (%)" , 
                                 "decent_homes_criteria", 
                                 "income_quintile_household") %>% 
  make_plot(.,
            decent_homes_criteria, income_quintile_household)

print(hh_income_plot)

```

#### Decent homes criteria by HH composition
```{r, echo = FALSE, fig.width=10}

hh_compostion_plot <- filter_for_plot("Households (%)" , 
                                 "decent_homes_criteria", 
                                 "household_composition") %>% 
  make_plot(.,
            decent_homes_criteria, household_composition)

print(hh_compostion_plot)

```

#### Decent homes criteria by length of residence
```{r, echo = FALSE, fig.width=10}

hh_reslength_plot <- filter_for_plot("Households (%)" , 
                                 "decent_homes_criteria", 
                                 "length_of_residence") %>% 
  make_plot(.,
            decent_homes_criteria, length_of_residence)

print(hh_reslength_plot)

```

#### Decent homes criteria by poverty status
```{r, echo = FALSE, fig.width=10}

hh_poverty_plot <- filter_for_plot("Households (%)" , 
                                 "decent_homes_criteria", 
                                 "poverty_status") %>% 
  make_plot(.,
            decent_homes_criteria, poverty_status)

print(hh_poverty_plot)

```

#### Decent homes criteria by workless HH
```{r, echo = FALSE, fig.width=10}

hh_workless_plot <- filter_for_plot("Households (%)" , 
                                 "decent_homes_criteria", 
                                 "workless_households") %>% 
  make_plot(.,
            decent_homes_criteria, workless_households)

print(hh_workless_plot)

```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(plot))
```

Finally, it is sometimes hard to see where new numbers don't match live numbers
especially if there are lots of disaggregations. In such cases a table of 
differences is also useful. The following example is taken from 13-2-2:
  
  At the time of writing this code (June 2022), the following note is given in the
  source notes tab: 'in these statistics the entire time series going back to 
  1990 is revised each year to take account of methodological improvements'.  
  
  **If there are differences (see table below) please check that this still stands**

```{r, , echo = FALSE}
comparison <- joined_data %>% 
  select(Year, Gas, Value, dataset) %>% 
  pivot_wider(names_from = dataset,
              values_from = Value) %>% 
  mutate(difference = new - live) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```
  
  The table below shows all instances where the old value does not match the new 
  value. It is sorted so the largest absolute differences appear first, but can
  be sorted in other ways using the arrows at the top.
```{r, echo = FALSE}
datatable(comparison, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

## Session Info
```{r}
pander(sessionInfo())
```

pander(sessionInfo())