title: "3-a-1 QA"
author: "Katie Uzzell"
date: "21/02/2023"
output: html_document

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(DT)
library(pander)
```

## 3-a-1 update summary

The 3-a-1 automation uses multiple tabs of one excel spreadsheet to report data
on 'Percentage of people who are current cigarette smokers aged 18 years and older'
disaggregated by sex, age, country, England region, country of birth, socio-economic
classification, and ethnicity.

This file runs some basic checks and gives information about the update.

Before putting the csv in the indicator file please check if the most recent 
figures are provisional. Check this in the source data. If they 
are, in the indicator csv file change the observation status to 'Provisional'.
Please also check the source data for any metadata that may also need to be included
on the platform.

Data for `r min(new_data$Year)` to `r latest_year` have been created and 
saved as `r paste0(date, "_3-a-1", ".csv")` in the 3-a-1 Output folder.  
    
### Check configurations

Please check that the information below is as you expect. In particular, pay 
attention to the time since data were saved, to check that previously 
downloaded data have not accidentally been used.
    
These settings can all be adjusted in `config.R`
    
Files used to create the new data were downloaded and saved in 
3-a-1/`r input_folder`.  
  
```{r include= FALSE}
filename_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", filename), 
                                full.names = TRUE)$ctime[1]
time_since_data_saved <- round(difftime(Sys.time(), filename_save_time, units = "days"), 2)

```

```{r include= FALSE}
old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/3-a-1.csv") %>%
  mutate(dataset = "old") %>%
  select(-GeoCode)

date <- Sys.Date()
new_data <- read.csv(paste0(output_folder, "/", date, "_3-a-1", ".csv"))

new_data <- new_data %>%
mutate(dataset = "new")

latest_year <- max(new_data$Year)

# join to the new data
joined_data <- old_data %>% 
  bind_rows(new_data) 

```

**Smoking habit data from health data team (ONS)**  

Smoking habit data are in the file `r filename`.   

This file was saved at `r filename_save_time`: It has been 
`r time_since_data_saved` days since the file was saved in 
`r input_folder`  

The tabs used is called
`r tabnames`. 

### Calculations

No calculations were performed on this data.

## Check data

Please check the plots below for any differences between the live and new data.
Live data will appear over the top of new data, so if you don't see points for
the new data on dates where there is also live data this is a good thing.  

```{r, echo = FALSE, fig.width=10}

# Country by type of disease
country_headline_plot <- joined_data %>% 
  filter(Region == "" & `Chronic respiratory disease subtype` == "" & Age == ""
         & Sex == "" ) %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Type of disease` ~ Country) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Country by Type of disease")


# Region by type of disease
region_headline_plot <- joined_data %>% 
  filter(Country =="England" & `Chronic respiratory disease subtype` == "" & Age == ""
         & Sex == "" ) %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Type of disease` ~ Region) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Region by Type of disease")


# Age by type of disease
age_headline_plot <- joined_data %>% 
  filter(`Chronic respiratory disease subtype` == "" & Region == "" & Sex == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Type of disease` ~ Age) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Age by Type of disease")


# Sex by type of disease
sex_headline_plot <- joined_data %>% 
  filter(Country == "England and Wales" & Region == "" & `Chronic respiratory disease subtype` == "" & Age == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Type of disease` ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Sex by Type of disease")

```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(country_headline_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(region_headline_plot))
```


```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(age_headline_plot))
```

  
```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(sex_headline_plot))
```


```{r, echo = FALSE, fig.width=10}

# Country by chronic respiratory disease subtype
chronic_respiratory_disease_plot <- joined_data %>% 
  filter(Region == "" & `Type of disease` == "Chronic respiratory disease" & Age == ""
         & Sex == "" ) %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Chronic respiratory disease subtype` ~ Country) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Country by chronic respiratory disease subtype")

# Region by chronic respiratory disease subtype
region_chronic_respiratory_disease_plot <- joined_data %>% 
  filter(Country == "England" & `Type of disease` == "Chronic respiratory disease" & Age == ""
         & Sex == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Chronic respiratory disease subtype` ~ Region) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Region by chronic respiratory disease subtype")


# Age by chronic respiratory disease subtype
age_chronic_respiratory_disease_plot <- joined_data %>% 
  filter(`Type of disease` == "Chronic respiratory disease" & Country == "England and Wales"
         & Region == "" & Sex == "" ) %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Chronic respiratory disease subtype` ~ Age) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Age by chronic respiratory disease subtype")


# Sex by chronic respiratory disease subtype
sex_chronic_respiratory_disease_plot <- joined_data %>% 
  filter(`Type of disease` == "Chronic respiratory disease" & Country == "England and Wales"
         & Region == "" & Age == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (joined_data$Year):max (joined_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(`Chronic respiratory disease subtype` ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Sex by chronic respiratory disease subtype")

```


```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(chronic_respiratory_disease_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(region_chronic_respiratory_disease_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(age_chronic_respiratory_disease_plot))
```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(sex_chronic_respiratory_disease_plot))
```



If there are differences, visible in the table below and plots, please investigate these.
It is possible the data source has update its back time series, so the difference
could be genuine. 

```{r, , echo = FALSE}
comparison <- joined_data %>% 
  select(Year, Country, Region, Age, Sex, `Type of disease`,
         `Chronic respiratory disease subtype`, Value, dataset) %>%
    na.omit(Value) %>%
  pivot_wider(names_from = dataset,
              values_from = Value)

# replace the NULL returns with NA

comparison <- comparison %>% 
  mutate(across("old":"new", ~replace(., lengths(.) == 0, ""))) %>% 
  mutate(new = as.numeric(new)) %>% 
  mutate(old = as.character(old)) %>%
  mutate(old = as.numeric(old))

comparison <- comparison %>% 
  mutate(difference = new - old) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```


The table below shows all instances where the old value does not match the new 
value. It is sorted so the largest absolute differences appear first, but can
be sorted in other ways using the arrows at the top.

```{r, echo = FALSE}
datatable(comparison, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```
  


## Session Info
```{r}
pander(sessionInfo())
```

