---
title: "QA of ODA indicator data"
author: "Emma Wood"
date: "25/07/2022"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(DT)
```
**Run date and time: `r Sys.time()`**  
  
## Introduction

Most of the ODA indicators use the same source: 
[Statistics on International Development (SID) Final UK Aid Spend](https://www.gov.uk/government/statistics/statistics-on-international-development-final-uk-aid-spend-2020).
This code has not been tested on the provisional data set, only the final spend.
   
It therefore makes sense to use automation to update these all at the same time,
even though most of them are very straightforward.   
  
This file records which indicators were run, shows which indicators failed (if 
any), and shows how the new data compare to the live data on charts.    
  
Please check the source data for any footnotes.
  
## Configurations

The input filepaths used for this output are:  

- ODA data: **`r paste0(getwd(), "/", input_folder, "/", filename)`**
- Exchange rates: **`r paste0(getwd(), "/", input_folder, "/", exchange_filename)`**
- Deflators: **`r paste0(getwd(), "/", input_folder, "/", deflators_filename)`**
- GNI url (for 1-a-1) **`r gni_api`**
  
The following indicators were included in the run:  
**`r indicators`**. See the next section to see if they all ran successfully.  
  
Indicator specific settings are:
- 2-a-2 broad sector code: **`broad_sector_code_2a2`**
- 4-b-1 type of aid code: **`r type_of_aid_code_4b1`**  
- 8-a-1 broad sector code: **`r broad_sector_code_8a1`**
 
The outputs are saved in: **`r  paste0(getwd(), "/",output_folder)`**  
  
  
## Basic checks

```{r}
failed_scripts <- setdiff(indicators, scripts_run)

if (length(failed_scripts) > 0) {
  print("The following indicators were not produced because they encountered an error:")
  failed_scripts
} else {
  print("All scripts ran successfully")
}


```

## Plots

Please check the plots below for any differences between the live data (which 
is pulled in from Jemalex) and the new data.  
  
New data will appear over the top of currently live data. 

### 1-a-1
```{r}
live_data_1a1 <- read.csv('https://raw.githubusercontent.com/ONSdigital/sdg-data/master/data/indicator_1-a-1.csv') %>% 
  janitor::clean_names()

new_data_1a1 <- csv_1a1 %>% 
  mutate(Year = as.integer(Year),
         dataset = "new") %>% 
  janitor::clean_names()
  
# join to the new data
joined_data_1a1 <- live_data_1a1 %>% 
  mutate(dataset = "live") %>% 
  bind_rows(new_data_1a1) 
#----

# by aid type
plot_1a1 <- joined_data_1a1 %>% 
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line(aes(linetype = dataset)) +
  facet_wrap(vars(poverty_reduction_aid_type), nrow = 2) +
  theme_bw() +
  ggtitle("1-a-1 by poverty reduction aid type") +
  ylab(unique(joined_data_1a1$units))
```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(plot_1a1))

```

### 2-a-2
```{r}
live_data_2a2 <- read.csv('https://raw.githubusercontent.com/ONSdigital/sdg-data/master/data/indicator_2-a-2.csv') %>% 
  janitor::clean_names()

new_data_2a2 <- csv_2a2 %>% 
  mutate(Year = as.integer(Year),
         dataset = "new") %>% 
  janitor::clean_names()
  
# join to the new data
joined_data_2a2 <- live_data_2a2 %>% 
  mutate(dataset = "live") %>% 
  bind_rows(new_data_2a2) 
#----

# by country_income_classification (GBP)
gbp_plot_2a2 <- joined_data_2a2 %>% 
  filter(grepl("GBP", units)) %>% 
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line(aes(linetype = dataset)) +
  facet_wrap(vars(country_income_classification), nrow = 2) +
  theme_bw() +
  ggtitle("2-a-2 by country income classification (GBP 000's)") 

# by country_income_classification (USD)
usd_plot_2a2 <- joined_data_2a2 %>% 
  filter(grepl("USD", units)) %>% 
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line(aes(linetype = dataset)) +
  facet_wrap(vars(country_income_classification), nrow = 2) +
  theme_bw() +
  ggtitle("2-a-2 by country income classification (constant USD 000's)")
```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(gbp_plot_2a2))
suppressMessages(print(usd_plot_2a2))

```


### 4-b-1
```{r}

live_data_4b1 <- read.csv('https://raw.githubusercontent.com/ONSdigital/sdg-data/master/data/indicator_4-b-1.csv') %>% 
  janitor::clean_names()

new_data_4b1 <- csv_4b1 %>% 
  mutate(Year = as.integer(Year),
         dataset = "new") %>% 
  janitor::clean_names()
  
# join to the new data
joined_data_4b1 <- live_data_4b1 %>% 
  mutate(dataset = "live") %>% 
  bind_rows(new_data_4b1) 
#----

# by cic
cic_plot_4b1 <- joined_data_4b1 %>% 
  filter((is.na(type_of_study) | type_of_study == "") & 
           (is.na(sector) | sector == "") & 
           substr(units, 1, 3) == "GBP") %>% 
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line(aes(linetype = dataset)) +
  facet_wrap(vars(country_income_classification), nrow = 3) +
  theme_bw() +
  ggtitle("4-b-1 by country income classification")

# by sector
sector_plot_4b1 <- joined_data_4b1 %>% 
  filter((is.na(type_of_study) | type_of_study == "") & 
           (is.na(country_income_classification) | country_income_classification == "") & 
           substr(units, 1, 3) == "GBP") %>% 
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line(aes(linetype = dataset)) +
  facet_wrap(vars(sector), nrow = 3) +
  theme_bw() +
  ggtitle("4-b-1 sector") 

# by type of study
study_plot_4b1 <- joined_data_4b1 %>% 
  filter((is.na(country_income_classification) | country_income_classification == "") & 
           sector == "Education" & 
           substr(units, 1, 3) == "GBP") %>% 
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line(aes(linetype = dataset)) +
  facet_wrap(vars(type_of_study), nrow = 3) +
  theme_bw() +
  ggtitle("4-b-1 by type of study")


```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(cic_plot_4b1))
suppressMessages(print(sector_plot_4b1))
suppressMessages(print(study_plot_4b1))
```

### 8-a-1
```{r}
live_data_8a1 <- read.csv('https://raw.githubusercontent.com/ONSdigital/sdg-data/master/data/indicator_8-a-1.csv') %>% 
  janitor::clean_names()

new_data_8a1 <- csv_8a1 %>% 
  mutate(Year = as.integer(Year),
         dataset = "new") %>% 
  janitor::clean_names()
  
# join to the new data
joined_data_8a1 <- live_data_8a1 %>% 
  mutate(dataset = "live") %>% 
  bind_rows(new_data_8a1) 
#----

# GBP
gbp_plot_8a1 <- joined_data_8a1 %>% 
    filter(grepl("GBP", units)) %>% 
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line(aes(linetype = dataset)) +
  facet_wrap(vars(country_income_classification), nrow = 2) +
  theme_bw() +
  ggtitle("8-a-1 by country income classification (GBP 000's)") 

# USD
usd_plot_8a1 <- joined_data_8a1 %>% 
    filter(grepl("USD", units)) %>% 
  ggplot(.,
         aes(x = year,
             y = value,
             colour = dataset)) +
  geom_point() +
  geom_line(aes(linetype = dataset)) +
  facet_wrap(vars(country_income_classification), nrow = 2) +
  theme_bw() +
  ggtitle("8-a-1 by country income classification (USD 000's)") 
```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(gbp_plot_8a1))
suppressMessages(print(usd_plot_8a1))

```

## Differences between live data and new data
It is sometimes hard to see where new numbers don't match live numbers
especially if there are lots of disaggregations.
The tables below show all instances where the old values do not match the new 
values. It is sorted so the largest absolute differences appear first, but can
be sorted in other ways using the arrows at the top.

### 1-a-1
```{r, , echo = FALSE}

comparison_data_1a1 <- joined_data_1a1 %>% 
  # because the £ is sometimes imported weirdly from a csv, make sure it is always the same for the new and live datasets
  mutate(units = ifelse(grepl("GPB", units) == TRUE, "GBP, thousands", units))

comparison_1a1 <- joined_data_1a1 %>% 
  select(year, poverty_reduction_aid_type,  
         units, dataset, value) %>% 
  pivot_wider(names_from = dataset,
              values_from = value) %>% 
  mutate(difference = new - live) %>% 
  filter(difference != 0) %>%
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```

```{r, echo = FALSE}
datatable(comparison_1a1, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```
### 2-a-2
```{r, , echo = FALSE}

comparison_data_2a2 <- joined_data_2a2 %>% 
  # because the £ is sometimes imported weirdly from a csv, make sure it is always the same for the new and live datasets
  mutate(units = ifelse(grepl("GPB", units) == TRUE, "GBP, thousands", units))

comparison_2a2 <- joined_data_2a2 %>% 
  select(year, country_income_classification,  
         units, dataset, value) %>% 
  pivot_wider(names_from = dataset,
              values_from = value) %>% 
  mutate(difference = new - live) %>% 
  filter(difference != 0) %>%
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```

```{r, echo = FALSE}
datatable(comparison_2a2, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

### 4-b-1
```{r, , echo = FALSE}

# at time of writing, the live data didn't include USD, so the pivot wider below
# didn't work correctly, so need to make sure the live and new datasets contain the same info
USD_in_live_4b1 <- TRUE %in% grepl("USD", unique(live_data_4b1$units))
if (USD_in_live_4b1 == FALSE) {
  comparison_data_4b1 <- joined_data_4b1 %>% 
    filter(grepl("USD", units) == FALSE) %>% 
    # because the £ is sometimes imported weirdly from a csv, make sure it is always the same for the new and live datasets
    mutate(units = ifelse(grepl("GBP", units) == TRUE, "GBP, thousands", units))
} else {
  comparison_data_4b1 <- joined_data_4b1 %>% 
    # because the £ is sometimes imported weirdly from a csv, make sure it is always the same for the new and live datasets
    mutate(units = ifelse(grepl("GPB", units) == TRUE, "GBP, thousands", units))
}

comparison_4b1 <- comparison_data_4b1 %>% 
  select(year, sector, type_of_study, country_income_classification, 
         units, dataset, value) %>% 
  pivot_wider(names_from = dataset,
              values_from = value) %>% 
  mutate(difference = new - live) %>% 
  filter(difference != 0) %>%
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```

```{r, echo = FALSE}
datatable(comparison_4b1, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

### 8-a-1
```{r, , echo = FALSE}

comparison_data_8a1 <- joined_data_1a1 %>% 
  # because the £ is sometimes imported weirdly from a csv, make sure it is always the same for the new and live datasets
  mutate(units = ifelse(grepl("GPB", units) == TRUE, "GBP, thousands", units))

comparison_8a1 <- joined_data_8a1 %>% 
  select(year, country_income_classification,  
         units, dataset, value) %>% 
  pivot_wider(names_from = dataset,
              values_from = value) %>% 
  mutate(difference = new - live) %>% 
  filter(difference != 0) %>%
  # put the largest differences at the top
  arrange(desc(abs(difference)))

```

```{r, echo = FALSE}
datatable(comparison_8a1, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

## Session Info
`r sessionInfo()`