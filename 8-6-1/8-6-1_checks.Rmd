
```{r include=FALSE}
      today <-Sys.Date() 
      
      # today <- as.Date(today, "%d/%m/%Y")
```
---
title: "8-6-1 checks"
author: "Abhishek Singh"
date: "**`r format(today, format="%d-%B-%Y")`**"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(pander)
```

```{r include= FALSE}

# Reading and formatting Old Data

old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/8-6-1.csv")


old_data$Series = gsub( "Proportion of youth not in education, employment or training (quarterly)",
                        "Quaterly", old_data$Series, fixed=TRUE)

old_data$Series = gsub("Proportion of youth not in education, employment or training",
                       "Yearly", old_data$Series, fixed=TRUE)

old_data$Age = gsub(".", "People", old_data$Age, fixed=TRUE)
old_data["Sex"][is.na(old_data["Sex"])] <- "People"


old_data$`Seasonally.adjusted.or.not` = str_replace(old_data$`Seasonally.adjusted.or.not`, "Seasonally adjusted", "SA")
old_data$`Seasonally.adjusted.or.not` = str_replace(old_data$`Seasonally.adjusted.or.not`, "Not seasonally adjusted", "NSA")


# System date
date <- Sys.Date()

# Reading and formatting NEW Data
new_data <- read.csv(paste0(output_folder, "/", date, "_update_8-6-1", ".csv"))

new_data$Series = gsub("Proportion of youth not in education, employment or training (quarterly)",
                       "Quaterly", new_data$Series, fixed=TRUE)

new_data$Series = gsub("Proportion of youth not in education, employment or training",
                       "Yearly", new_data$Series, fixed=TRUE)

new_data["Sex"][is.na(new_data["Sex"])] <- "People"

new_data$`Seasonally.adjusted.or.not` = str_replace(new_data$`Seasonally.adjusted.or.not`, "Seasonally adjusted", "SA")

new_data$`Seasonally.adjusted.or.not` = str_replace(new_data$`Seasonally.adjusted.or.not`, "Not seasonally adjusted", "NSA")

latest_year <- max(new_data$Year)

```

## 8-6-1 update summary

Data for `r min(new_data$Year)` to `r latest_year` have been created and 
saved as `r paste0(date, "_8-6-1", ".csv")` in the 8-6-1 Output folder.  
    
### Check configurations
Please check that the information below is as you expect. In particular, pay 
attention to the time since data were saved, to check that previously 
downloaded data have not accidentally been used.
    
These settings can all be adjusted in `config.R`
    
Files used to create the new data were downloaded and saved in 
8-6-1/`r input_folder`.  
  
```{r include= FALSE}
filename_save_time <- file.info(paste0(getwd(),"/",input_folder,"/", filename), 
                                full.names = TRUE)$ctime[1]
time_since_data_saved <- round(difftime(Sys.time(), filename_save_time, units = "days"), 2)

```

**Proportion of youth (aged 15â€“24 years) not in education, employment or training (NEET)**  

NEET data is in the file `r filename`.   

This file was saved at `r filename_save_time`: It has been 
`r time_since_data_saved` days since the file was saved in 
`r input_folder`  

The tab used is 
**`r people_sa_tabname`, `r people_nsa_tabname`,  `r men_sa_tabname`,  `r men_nsa_tabname`,  `r women_sa_tabname`,  `r women_nsa_tabname`**







### Check data




The charts below show the new data (just created) plotted on top of the old data,
which has been downloaded from the live site. If there are unexpected 
discrepancies in the lines please investigate the reasons for these discrepancies.
    
```{r, echo=FALSE, fig.width=70, fig.height=15}
new_data <- new_data %>%
mutate(Year = as.character(Year),
         dataset = "new")

# For review, how to plot Q1 till Q4?



new_data$Value <- as.numeric(new_data$Value)

joined_data <- old_data %>%
  mutate(dataset = "old") %>%
  bind_rows(new_data)

Yearly_plot_data  <- joined_data %>% 
  filter(Series == "Yearly") 



# filter and format yearly data from joined data
Yearly_data <- joined_data %>%
  filter(Series == "Yearly")

Yearly_data <- Yearly_data %>% 
      mutate(Year = as.numeric(Year), Value = as.numeric(Value))



# Yearly plot

Yearly_plot <- Yearly_data %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  scale_x_continuous (breaks=min (Yearly_data$Year):max (Yearly_data$Year)) +
  geom_point() +
  geom_line() +
  facet_grid(~Series ~Seasonally.adjusted.or.not ~ Age ~ Sex) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 7)) +
  theme(axis.text.y = element_text(size = 7)) +
  ggtitle("Proportion of youth not in education, employment or training by Year (Annual) NEET")
  

# Quarterly Plot
mx <- max(joined_data$Value)
mn <- min(joined_data$Value)
plot <- joined_data %>%
  filter(Series == "Quaterly") %>%
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  geom_point(aes(shape = dataset)) +
  geom_line() +
  geom_point() +
  facet_grid(~Series ~Seasonally.adjusted.or.not ~Age  + Sex ~ .,scales='free_x', space='free')+
  scale_x_discrete(expand = c(0, 0.5) ) +
  theme_bw() +
  theme(strip.text.y = element_text(size = 5))+ 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, size = 5)) +
  theme(axis.text.y = element_text(size = 5)) +
  expand_limits(y = c(mn, mx)) +
  ggtitle("Proportion of youth not in education, employment or training Quarterly (NEET)")

```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(plot))

```


```{r, echo = FALSE, fig.height = 8, fig.width = 10}
suppressMessages(print(Yearly_plot))
```





### Calculations

Calculations were made to Calculate Annual data. This Annual data was calculated from the quarterly data using a 4 Quarter average. 

The calculations used to create these data were:
```

 Annual data was calculated from the quarterly data using a 4 Quarter average
 
 For example,  2000 = (2000 Q1 + 2000 Q2 + 2000 Q3 + 2000 Q4)/4

```

## Session Info
```{r}
pander(sessionInfo())
```
