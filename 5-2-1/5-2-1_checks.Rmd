---
title: "5-2-1"
author: "Michael Nairn"
date: "16/01/2023"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
library(DT)
library(pander)
```


**Run date and time: `r Sys.time()`**

## Introduction

Motivation for automation: 
Partner abuse statistics required for Indicator 5.2.1 are spread across multiple sheets of a much larger dataset  https://www.ons.gov.uk/peoplepopulationandcommunity/crimeandjustice/datasets/domesticabuseprevalenceandvictimcharacteristicsappendixtables . Manually going through these sheets to find all of the
required data is laborious and, more pertinently, prone to error. 

Automation should improve consistency. 


Things to check:
Ensure only data for women, and abuse by partner, are selected.
Future publications include the same tables. 



## Configurations

There are 4 sheets within the year ending March 2022 data source.
https://www.ons.gov.uk/peoplepopulationandcommunity/crimeandjustice/datasets/domesticabuseprevalenceandvictimcharacteristicsappendixtables

Table 1 - Prevalence of domestic abuse among adults aged 16 years and over, by type of abuse and sex, 

Table 3 - Prevalence of domestic abuse in the last year among adults aged 16 to 59, by type of abuse and sex, 

Table 6 - Prevalence of domestic abuse in the last year among adults aged 16 years and over, by personal characteristics and sex, 

Table 7 - Prevalence of domestic abuse in the last year among adults aged 16 years and over, by household and area characteristics and sex, 


# Basic checks

This file runs some basic checks and gives information about the update.
  
Before putting the csv in the indicator file please check if the most recent 
figures are provisional. Check this in the source data. If they 
are, in the indicator csv file change the observation status to 'Provisional'.


Now let's fetch the original data and compare it to our updated set. Unless values for previous years have been amended, the two datasets should differ only in the adding of extra rows for the newly included years.



```{r echo=FALSE}
old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/5-2-1.csv", check.names = FALSE) %>% 
  mutate(`Sexual orientation` = "", `Gender identity` = "", Religion = "",
         `Marital status` = "",`Employment status` = "",`Occupation type` = "",
         `Highest qualification` = "", `Household income` = "",`Household tenure` = "",
         `Accommodation type` = "",`Output area classification` = "",
         `Urban or rural` = "") %>%
  mutate(across(where(is.factor), as.character)) %>% 
  mutate(Value = as.factor(Value)) %>%
  mutate(
    Country = case_when(
      Region == "Wales" ~ Region, 
      Region == "North East" ~ "England", 
      Region == "North West" ~ "England", 
      Region == "Yorkshire and The Humber" ~ "England", 
      Region == "East Midlands" ~ "England", 
      Region == "West Midlands" ~ "England", 
      Region == "East of England" ~ "England", 
      Region == "London" ~ "England", 
      Region == "South East" ~ "England",
      Region == "South West" ~ "England",
      TRUE ~ ""),
    Region = case_when(
      Country == "England" ~ Region,
      TRUE ~ "")) %>%
  select(Year, Series, `Type of partner abuse`, `Abuse sub-category`,
         Age, Ethnicity, `Ethnic group`, `Disability status`, `Country of birth`,
         `Sexual orientation`, `Gender identity`, Religion, `Marital status`,
         `Employment status`, `Occupation type`,
         `Highest qualification`, `Household income`, `Household tenure`, `Accommodation type`,
         `Output area classification`, `Urban or rural`, Country, Region, 
         `Observation status`, Units, `Unit multiplier`, Value) %>%
  mutate(dataset = "old") 


date <- Sys.Date()

new_data <- read.csv(paste0(output_folder, "/", date, "_update_5-2-1", ".csv"), check.names = FALSE) %>% 
  mutate(dataset = "new")
          

# join to the new data
joined_data <- old_data %>% 
  bind_rows(new_data) 
  
```


# Use the code below to check for discrepancies ----
print("Below is a table of the non-matching rows for the original and updated data, it should only be populated for years which are later than are covered in the original data")



If there are differences, visible in the table below and plots, please investigate these.
It is possible the data source has update its back time series, so the difference
could be genuine. 

```{r, , echo = FALSE}
comparison <- joined_data %>% 
  pivot_wider(names_from = dataset,
              values_from = Value)

# replace the NULL returns with NA
comparison <- comparison %>% 
  mutate(across("old":"new", ~replace(., lengths(.) == 0, ""))) %>% 
  mutate(new = as.character(new)) %>% 
  mutate(new = as.numeric(new)) %>% 
  mutate(old = as.character(old)) %>%
  mutate(old = as.numeric(old))
comparison <- comparison %>% 
  mutate(difference = new - old) %>% 
  filter(difference != 0) %>% 
  # put the largest differences at the top
  arrange(desc(abs(difference)))
```


The table below shows all instances where the old value does not match the new 
value. It is sorted so the largest absolute differences appear first, but can
be sorted in other ways using the arrows at the top.

```{r, echo = FALSE}
datatable(comparison, 
          rownames = FALSE, 
          filter = "top",
          options = list(dom = 'tp', 
                         pageLength = 10,
                         columnDefs = list(list(
                           className = 'dt-center', targets = 0:3))))
```

# Plots
There are too many possible time series to plot here (>100) but below are a few examples you can amend if there seems to be a discrepancy shown in the table above. If for all plots below you see only one shape of point marker, the original and updated datasets can be assumed identical in value for the selection shown in the plot.

The example plot below is just a the headline plot. Please edit the filter
and facet grid as required to visualise the differences.


```{r echo=FALSE}

# This is just a headline plot. Please edit the filter and facet grid
  # as required to visualise the differences.

headline_plot <- joined_data %>% 
  filter(`Type of partner abuse` != "" & `Abuse sub-category` == "") %>% 
  ggplot(.,
         aes(x = Year,
             y = Value,
             colour = dataset)) +
  # Add marker variables to the old_data and new_data so we can know which set a point is from
  geom_point(aes(shape = dataset)) + 
  geom_line() +
  facet_grid(`Type of partner abuse` ~ Series) +
  theme_bw() +
  ggtitle("Partner abuse by type of abuse")

```

```{r, echo = FALSE, fig.width=10, fig.height = 10}
suppressMessages(print(headline_plot))
```
## Session Info
```{r}
pander(sessionInfo())
```