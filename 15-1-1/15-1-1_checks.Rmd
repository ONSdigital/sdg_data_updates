---
title: "15-1-1 checks"
author: "Emma Wood"
date: "27/07/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load-packages, include=FALSE}
library(tidyr)
library(dplyr)
library(ggplot2)
library(kableExtra)
```

```{r include= FALSE}
source('config.R')

old_data <- read.csv("https://sdgdata.gov.uk/sdg-data/en/data/15-1-1.csv")

date <- Sys.Date()
new_data <- read.csv(paste0("Output/", date, "_15-1-1", ".csv")) 
pre_calcs_data <- read.csv(paste0("Output/", date, "_before_calcs_15-1-1.csv")) 

latest_year <- max(new_data$Year)

```

## 15-1-1 update summary

Data for `r min(new_data$Year)` to `r latest_year` have been created and 
saved as `r paste0(date, "_15-1-1", ".csv")` in the 15-1-1 Output folder.  
    
### Check configurations
Please check that the information below is as you expect. In particular, pay 
attention to the time since data were saved, to check that previously 
downloaded data have not accidentally been used.
    
These settings can all be adjusted in `config.R`
    
Files used to create the new data were downloaded and saved in 
15-1-1/`r input_folder`.  
  
```{r include= FALSE}
woodland_file_save_time <- file.info(paste0(getwd(),"/Input/", woodland_filename), full.names = TRUE)$ctime[1]
time_since_woodland_data_saved <- round(difftime(Sys.time(), woodland_file_save_time, units = "days"), 2)

area_file_save_time <- file.info(paste0(getwd(),"/Input/", area_filename), full.names = TRUE)$ctime[1]
time_since_area_data_saved <- round(difftime(Sys.time(), area_file_save_time, units = "days"), 2)

```
<br>

**Woodland data from Forest Research**  
Woodland area data are in the file `r woodland_filename`.   

This file was saved at `r woodland_file_save_time`: It has been 
`r time_since_woodland_data_saved` days since the file was saved in 
`r input_folder`  

The tab used for 'all woodland' areas is called
`r woodland_area_tabname`, and the tab used for certified woodland area is called 
`r certified_area_tabname`.  
    
<br>

**Country area data from the geoportal**  
Total area for countries is in the file `r area_filename`  
  
This file was saved at `r area_file_save_time`:  It has been 
`r time_since_area_data_saved` days since the file was saved in 
`r input_folder`  
    

### Check data
The charts below show the new data (just created) plotted on top of the old data,
which has been downloaded from the live site. If there are unexpected 
discrepancies in the lines please investigate the reasons for these discrepancies.
    
```{r, echo=FALSE, fig.width=7, fig.height=5}
new_data_to_plot <- mutate(new_data, dataset = "2 new")
old_data_to_plot <- mutate(old_data, dataset = "1 old") 

status_list <- unique(new_data_to_plot$Sustainably.managed.status)

new_data_to_plot %>%
    bind_rows(old_data_to_plot) %>% 
    ggplot(data = .,
           aes(x = Year,
               y = Value,
               colour = dataset)) +
    geom_point() +
    geom_line() +
    facet_grid(Country ~ Sustainably.managed.status) +
    theme_bw() 

```

### Calculations done
The calculations used to create these data were:
```
indicator_data <- all_data %>% 
  mutate(woodland_proportion = (woodland_area * 1000000) / AREALHECT * 100,
         certified_proportion = (certified_area * 1000000) / AREALHECT * 100,
         non_certified_proportion = ((woodland_area - certified_area) * 1000000) / AREALHECT * 100) 
```
Warning: This is copied from `update_15-1-1.R` and will not dynamically update 
if that code is changed.

### Analysis
At the time of writing this markdown doc, 15-1-1 contains some extra stats in the
free text at the top of the indicator page.

These are as follows:    
    
```{r include = FALSE}
woodland_certified_in_UK <- pre_calcs_data %>% 
  mutate(percent_of_woodland = (certified_area / woodland_area) * 100) %>% 
  filter(YEAR == latest_year, Country == "UK") %>% 
  pull(round(percent_of_woodland, 1))

percent_increase_since_2015 <- new_data %>% 
  filter(Country == "", Year %in% c(2015, latest_year), 
         Sustainably.managed.status == "") %>%
  mutate(Year = ifelse(Year == latest_year, "latest", "start")) %>% 
  pivot_wider(names_from = Year,
              values_from = Value) %>% 
  mutate(Value = (latest - start) / start * 100) %>% 
  pull(round(Value, 1))
```

- `r round(woodland_certified_in_UK, 1)`% of woodland area in the UK is certified as 
sustainably managed
- Since the adoption of the SDGs in 2015, the percentage increase of woodland area (as a percentage of total area) in the UK
is `r round(percent_increase_since_2015, 1)`%
- Area of woodland in the UK: taken from the woodland statistics bulletin    
which represents the following percent of land area in each country:

```{r echo = FALSE}
new_data %>% 
  filter(Sustainably.managed.status == "",
         Year == 2021) %>% 
  select(Year, Country, Value) %>% 
  mutate(Country = ifelse(Country == "", "UK", as.character(Country)),
         Value = round(Value, 1)) %>% 
    kbl() %>%
    kable_styling()
```



Further analysis could be reported (and added to this file), but just sticking 
with what we already had for now.
