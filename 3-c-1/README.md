### 3-c-1 automation
  
This automation pulls two datasets from nomis and joins them on year, country and region.  
It does some basic calculations:
1. subtract vets from the health professionals occupation minor group totals  
2. calculate density by 10,000 population
  
When I started this automation, the live site included a sex disaggregation where the 
calculation was number of female heath workers / female population.  
I have dropped the sex disaggregation as disaggregating by sex does not make sense for this indicator: 
Density of health workers (of any sex) per 10 000 women/ men could give useful information if there 
wasn't an even distribution of men and women by region, however this is not the case.
  
### Instructions to run update ###
1. *UK SDG data team:* (once this code has been reviewed and is on the main branch) Go to Jemalex > sdg_data_updates.    
   *Others:* Checkout sdg_data_updates main branch to your local repository.     
2. Open sdg_data_updates.Rproj  
3. In update_inidcator_main if it isn't already 3-c-1 change the indicator folder name (`indicator = "3-c-1"`)  
4. If config.R does not exist in the 3-c-1 older, create it from the example_config.R file  
5. Check the configs are correct. The nomis links should not need to be edited, unless you want to add or remove occupation codes. 
6. Check that the compile_tables.R script sources the correct config file (for an update it should call config.R. 
To run the example data and get example output, it should be example_config.R).   
7. Open update_indicator_main.R  
8. Click Source (by default this is in top right of the script window)  
9. Check for messages in the console. When the script is run a file titled '3.c.1.csv' will be saved in 3-c-1 > Output 
   Use this file for the Indicator csv.  
10. A file called <date>_3-c-1_checks.html will also be in the outputs folder. Read through this as a QA of the csv. See the section on 'Checking the QA file' below. 

### Instructions for metadata ###
The last updated date is not generated by the script. However you can get this from the bottom of the review selections section
on Nomis for [health workers](https://www.nomisweb.co.uk/query/construct/summary.asp?mode=construct&version=0&dataset=168) and
[population](https://www.nomisweb.co.uk/query/construct/summary.asp?mode=construct&version=0&dataset=31). *note: check the population link
when census 2021 numbers are out.*
  
### Generation of nomis links ###
The nomis links should not need to be regenerated unless we decide to to e.g. change the selected occupation codes  
or use a different population estimate (e.g. when the new estimates from census 2021 are out).  
The current nomis links were generated as follows:

#### health worker numbers ####
From Nomis, select Query, then Annual Population Survey/Labour Force Survey >  annual population survey - regional - employment by occupation   
  
Selections:
   countries: England, Scotland, Northern Ireland, Wales, United Kingdom
   regions: all except the devolved countries
   occupations: deselect any auto ticks. Select 221, 222, 223, 321, and all the 4-digit codes under these
   sex: all ONLY (see note below)
   date: depends on whether it is a normal update or a full backseries run (e.g. if need to use new population figure)
         for normal update: select dates between - the most recent 8 dates, QUARTERLY 
         for back series data: select individual dates (select all December dates - equivalent of ANNUAL)

To generate link go to format/layout and select API. Then in 'Download data' right click on the csv link and copy the link.
Check last updated date [here](https://www.nomisweb.co.uk/query/construct/summary.asp?mode=construct&version=0&dataset=168).  

#### population size ####
From Nomis, select Query, then Population estimates/Projections > population estimates - local authority based by 5 year age band  
To generate link go to format/layout and select API. Then in 'Download data' right click on the csv link and copy link
Check last updated date [here](https://www.nomisweb.co.uk/query/construct/summary.asp?mode=construct&version=0&dataset=31) *note: check this link
when census 2021 numbers are out.*  
  
#### Checking the QA file ####
The main thing to check in this file is that the graphs look how you expect them to. If you have not made any changes to the 
disaggregations there should be both red and blue lines on every facet of every chart. However, if you have added or removed 
any disaggregations you may get warnings such as 'Removed 20 rows containing missing values (geom_point).' In such cases this
is to be expected. *However*, if you have not intentionally changed which disaggregations should be output, and you still get 
this warning something has gone wrong. As an initial check, remake the nomis link and try again.  
  
If graphs have got strange looking vertical lines on them, an extra disaggregation has crept into the data (i.e. there are
extra unexpected rows in the data), or a column name has changed.  

### Decisions to be made: ### 
- Are we using the right SOC2010 codes? 
  The UN reqests a small subset of what we report - should we just be reporting those? Are there SDMX implications to including more?
  
### Code edits that may be needed: ###  
- to be SDMX compatible maybe use the subset of SOC2010 codes specified in the metadata. 
  This will require generating the nomis link agaiin and putting it in the config.R file.
  It will also require a simplification of the code:
  - get rid of the section where vets are subtracted from health professsionals
  - get a headline figure (e.g. `group_by(Year) %>% summarise(Value = sum(Value))`)

  
