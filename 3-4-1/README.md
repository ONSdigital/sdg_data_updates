### 3-4-1 automation
  
This automation pulls together all relevant ICD-10 classification codes off NOMIS to display their mortality rate per 100,000 disaggregated by country, region and sex. Currently region age dissagregation starts from 30 years and over, with all other disaggregations starting from 0. 
  
### Instructions to run update ###
1. *UK SDG data team:* (once this code has been reviewed and is on the main branch) Go to Jemalex > sdg_data_updates.    
   *Others:* Checkout sdg_data_updates main branch to your local repository.     
2. Open sdg_data_updates.Rproj  
3. Change indicator folder name (`indicator <- "3-4-1"`)  
4. If config.R does not exist in the 3-4-1 folder, create it from the example_config.R file  
5. Check the configs are correct. The nomis links should not need to be edited, unless you want to add or remove occupation codes. 
6. Check that the compile.tables.R script sources the correct config file (for an update it should call config.R. 
To run the example data and get example output, it should be example_config.R).   
7. Open update_indicator_main.R  
8. Click Source (by default this is in top right of the script window)  
9. Check for messages in the console. When the script is run a file titled '3-4-1.csv' will be saved in 3-4-1 > Output 
   Use this file for the Indicator csv.  
10. A file called <date>_3-4-1_checks.html will also be in the outputs folder. Read through this as a QA of the csv.  

### Instructions for metadata ###
The last updated date is not generated by the script. However you can get this from the bottom of the review selections section
on Nomis for [*mortality totals links*](nomis link used in the configs). 

  
### Generation of nomis links ###
The nomis links should not need to be regenerated unless we decide to change underlying cause selections or alter other dissagregations.
If nomis is being used without an account, the downloaded dataset is cropped at 25000 rows. Link generation will depend on whether you are using an account. It is suggested to ensure you are signed into a NOMIS, but the code is set up for where this is not the case. 

The current nomis links were generated as follows:

#### Mortality rate numbers ####
From Nomis, select Query > Life Events > Mortality statistics - underlying cause, sex and age.

Selections (if we have an account so only one link):  
   Geography: Countries (all) > Regions (all)  
   Date: All years  
   Age: All years (except for regions where currently 30 and over)  
   Rates: Age-standardised mortality rate only   
   Sex: All   
   Underlying Cause: Full ICD-10 Clasification > C00-C97, E10-E14, I00-I99, J30-39, J40-J47, J60-J70, J80-J84, J85-J86, J90-94, J95, J96, J98 and LC47  
     
totals links selections:  
   Geography: Countries (all)  
   Date: All years  
   Age: All years (except for regions where currently 30 and over)  
   Rates: Age-standardised mortality rate only   
   Sex: Totals only   
   Underlying Cause: Full ICD-10 Clasification > C00-C97, E10-E14, I00-I99, J30-39, J40-J47, J60-J70, J80-J84, J85-J86, J90-94, J95, J96, J98 and LC47  
  
male link selections:  
   Geography: Countries (all)  
   Date: All years  
   Age: All years (except for regions where currently 30 and over)  
   Rates: Age-standardised mortality rate only   
   Sex: Males only   
   Underlying Cause: Full ICD-10 Clasification > C00-C97, E10-E14, I00-I99, J30-39, J40-J47, J60-J70, J80-J84, J85-J86, J90-94, J95, J96, J98 and LC47  
     
female link selections:
   Geography: Countries (all)
   Date: All years
   Age: All years (except for regions where currently 30 and over)
   Rates: Age-standardised mortality rate only 
   Sex: Females only 
   Underlying Cause: Full ICD-10 Clasification > C00-C97, E10-E14, I00-I99,       J30-39, J40-J47, J60-J70, J80-J84, J85-J86, J90-94, J95, J96, J98 and LC47
   
regions link selections:  
   Geography: Regions (all)  
   Date: All years  
   Age: All years (except for regions where currently 30 and over)  
   Rates: Age-standardised mortality rate only   
   Sex: All  
   Underlying Cause: Full ICD-10 Clasification > C00-C97, E10-E14, I00-I99, J30-39, J40-J47, J60-J70, J80-J84, J85-J86, J90-94, J95, J96, J98 and LC47  
   
To generate link go to format/layout and select API. Then in 'Download data' right click on the csv link and copy link
Check last updated date [here](https://www.nomisweb.co.uk/query/construct/summary.asp?mode=construct&version=0&dataset=168)


### Code edits that may be needed: ###  
*Note to QA: despite breaking up data link reigon data is still over 25000 lines so gets cut off, I think someone now has a NOMIS account to remove this issue however unsure so this would need fixing before fully complete. Also, when making this update  I followed how it was done on platform i.e starting region from 30 yrs and over however on reflection probably no need to do this now automated presume this method was taking for manual update as mostly NAs before this. Thus, if we do go from 0 this link would need be re-copied with updated age selections. Also  explained how to get data for each link and how to get all data at once(total), if have an account the total may be the only relevant one*
  
